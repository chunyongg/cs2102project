----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- 8. find_rooms: This routine is used to find all the rooms that could be used for a course session.
-- Inputs: session date, session start hour, and session duration
-- Returns: a table of room identifiers.

CREATE OR REPLACE FUNCTION find_rooms (IN sess_date DATE, IN start_time TIMESTAMP, IN duration INTEGER, OUT room_id INTEGER)
RETURNS SETOF RECORD AS $$
    SELECT DISTINCT room_id
    FROM Rooms R
    EXCEPT
    SELECT DISTINCT C.room_id
    FROM Conducts C
    WHERE C.sess_date = sess_date
    AND NOT EXISTS (
        SELECT DISTINCT C2.room_id
        FROM Conducts C2
        WHERE C2.sess_date = sess_date
        AND C2.end_time <= start_time
        AND C2.start_time >= start_time + duration
    ) -- end before input start_time AND start after input end_time
 $$ LANGUAGE SQL
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- 9. get_available_rooms: This routine is used to retrieve the availability information of rooms for a specific duration.
-- Inputs: start date and end date
-- Returns: a table of records consisting of the following information:
-- room identifier, room capacity, day (which is within the input date range [start date, end date]),
-- and an array of the hours that the room is available on the specified day. The output is sorted in ascending order of room identifier and day, and the array entries are sorted in ascending order of hour.

CREATE OR REPLACE FUNCTION get_available_rooms (IN start_date DATE, IN end_date DATE, OUT room_id INT, OUT room_capacity INT, OUT day DATE, OUT hours INT[])
RETURNS SETOF RECORD AS $$
    DECLARE
        day DATE;
    BEGIN
        day := start_date
        LOOP
            EXIT WHEN day > end_date;
            SELECT room_id, seating_capacity, day, hours;
            day := day + 1;
    END;
$$ LANGUAGE SQL
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- 11. add_course_package: This routine is used to add a new course package for sale.
-- Inputs: package name, number of free course sessions, start and end date indicating the duration that the promotional package is available for sale, and the price of the package.
-- The course package identifier is generated by the system. If the course package information is valid, the routine will perform the necessary updates to add the new course package.

CREATE OR REPLACE PROCEDURE add_course_package (package_name TEXT, num_free_registrations INT, sale_start_date DATE, sale_end_date DATE, price NUMERIC(10, 2))
AS $$
    INSERT INTO CoursePackages(package_name, num_free_registrations, sale_start_date, sale_end_date, price)
        VALUES (package_name, num_free_registrations, sale_start_date, sale_end_date, price);
$$ LANGUAGE SQL

-- e.g. call add_course_package ('Valentines Day Sales', 2, '2021-02-01', '2021-11-01', 4000);
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- 12. get_available_course_packages: This routine is used to retrieve the course packages that are available for sale.
-- Returns: a table of records with the following information for each available course package:
-- package name, number of free course sessions, end date for promotional package, and the price of the package.

CREATE OR REPLACE FUNCTION get_available_course_packages (OUT package_name TEXT, OUT num_free_registrations INT, OUT sale_end_date DATE, OUT price NUMERIC)
RETURNS SETOF RECORD AS $$
    SELECT package_name, num_free_registrations, sale_end_date, price
    FROM CoursePackages
$$ LANGUAGE SQL

-- e.g. select get_available_course_packages()
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


-- F6:
CREATE OR REPLACE FUNCTION find_instructors (
    IN cid INTEGER, IN session_date DATE, IN session_hour INTEGER, 
    OUT emp_id INTEGER, OUT emp_name TEXT)
RETURNS RECORD AS $$
    SELECT emp_id, emp_name
    FROM Employees
    NATURAL JOIN Instructors
    INNER JOIN Sessions
    ON Instructors.emp_id = Sessions.instructor_id 
    WHERE Sessions.course_id = cid
    AND Sessions.sess_date = session_date
    AND session_hour IN (SELECT DATE_PART('hour', Sessions.start_time));
$$ LANGUAGE sql;

-- F7:

-- F15:
CREATE OR REPLACE FUNCTION get_available_course_offerings (
)

-- F16:
CREATE OR REPLACE FUNCTION get_available_course_sessions (
    OUT session_date DATE, OUT session_hour INTEGER, OUT inst_name TEXT, OUT seat_remaining INTEGER)
RETURNS SETOF RECORD AS $$
    SELECT sess_date, DATE_PART('hour', start_time), emp_name,
	(SELECT seating_capacity 
	 FROM CourseOfferings 
	 WHERE CourseOfferings.launch_date = Sessions.launch_date
	 EXCEPT
	 SELECT COUNT(*) FROM Registers
	 WHERE Registers.sess_id = Sessions.sess_id)
    FROM Sessions
    INNER JOIN Employees
	ON Sessions.instructor_id = Employees.emp_id
    ORDER BY (sess_date, DATE_PART('hour', start_time));
$$ LANGUAGE sql;